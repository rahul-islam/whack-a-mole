<html>

<head>
  <title>Augmented Reality Marker Detector</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.dom.min.js"></script>
  <script src="https://unpkg.com/ml5@0.2.2/dist/ml5.min.js" type="text/javascript"></script>

  <script type="text/javascript" src="./js/polyfill.js"></script> 
  
  <script type="text/javascript" src="./js/cv.js"></script> 
  <script type="text/javascript" src="./js/aruco.js"></script> 
  

  <script>
    var video, canvas, context, imageData, detector, canvas1, poseNet, poses = [];
    var button_value = false;
    var button_value_2 = false;
    var user_Data = {};
    var user_Data_2 = {
        'fname' : 'Foo',
        'lname' : 'Bar'
    };
    var user_ip;

    function setup(){
      canvas1 = createCanvas(640, 480);
      video = createCapture(VIDEO);
      video.size(width, height);
      canvas = canvas1.canvas;
      context = canvas.getContext("2d");
    
      canvas.width = parseInt(canvas.style.width);
      canvas.height = parseInt(canvas.style.height);
      
      poseNet = ml5.poseNet(video, modelLoaded);
      
      poseNet.on('pose', function(results) {
        poses = results;
      });
      // Hide the video element, and just show the canvas
      video.hide();

      detector = new AR.Detector();

      requestAnimationFrame(tick);
    }
    
    
    function getUserIP(onNewIP) { //  onNewIp - your listener function for new IPs
    //compatibility for firefox and chrome
    var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    var pc = new myPeerConnection({
        iceServers: []
    }),
    noop = function() {},
    localIPs = {},
    ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g,
    key;

    function iterateIP(ip) {
        if (!localIPs[ip]) onNewIP(ip);
        localIPs[ip] = true;
    }

     //create a bogus data channel
    pc.createDataChannel("");

    // create offer and set local description
    pc.createOffer().then(function(sdp) {
        sdp.sdp.split('\n').forEach(function(line) {
            if (line.indexOf('candidate') < 0) return;
            line.match(ipRegex).forEach(iterateIP);
        });
        
        pc.setLocalDescription(sdp, noop, noop);
    }).catch(function(reason) {
        // An error occurred, so handle the failure to connect
    });

    //listen for candidate events
    pc.onicecandidate = function(ice) {
        if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
        ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
    };
}


getUserIP(function(ip){
    user_ip = ip.toString()
    alert("Got IP! :" + ip);
});


    function modelLoaded() {
      console.log('Model Loaded!');
    }

    function tick(){
      requestAnimationFrame(tick);
      image(video, 0, 0, width, height);
      imageData = context.getImageData(0, 0, width, height);
        var markers = detector.detect(imageData);
        drawCorners(markers);
        drawId(markers);
        drawKeypoints();
      drawSkeleton();
    }

    function snapshot(){
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    }

    // A function to draw ellipses over the detected keypoints
    function drawKeypoints()Â  {
      // Loop through all the poses detected
      for (let i = 0; i < poses.length; i++) {
        // For each pose detected, loop through all the keypoints
        let pose = poses[i].pose;
        for (let j = 0; j < pose.keypoints.length; j++) {
          // A keypoint is an object describing a body part (like rightArm or leftShoulder)
          let keypoint = pose.keypoints[j];
          // Only draw an ellipse is the pose probability is bigger than 0.2
          if (keypoint.score > 0.2) {
            fill(255, 0, 0);
            noStroke();
            ellipse(keypoint.position.x, keypoint.position.y, 10, 10);
          }
        }
      }
    }

    // A function to draw the skeletons
    function drawSkeleton() {
      // Loop through all the skeletons detected
      for (let i = 0; i < poses.length; i++) {
        let skeleton = poses[i].skeleton;
        // For every skeleton, loop through all body connections
        for (let j = 0; j < skeleton.length; j++) {
          let partA = skeleton[j][0];
          let partB = skeleton[j][1];
          stroke(255, 0, 0);
          line(partA.position.x, partA.position.y, partB.position.x, partB.position.y);
        }
      }
    }
          
    function drawCorners(markers){
      var corners, corner, i, j;
    
      context.lineWidth = 3;

      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        context.strokeStyle = "red";
        context.beginPath();
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          context.moveTo(corner.x, corner.y);
          corner = corners[(j + 1) % corners.length];
          context.lineTo(corner.x, corner.y);
        }

        context.stroke();
        context.closePath();
        
        context.strokeStyle = "green";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
      }
    }
    function Enrollment(marker_id,pose_lenth) {
          if(pose_lenth==0)
          {   
               alert (marker_id);
               
              //  alert(user_Data);
          }
          else{
            alert(marker_id+' pose detected')
            // user_Data[marker_id]=ip;
            // alert(user_Data);
          }
               //document.write ("This is a warning message!");
            }

    function change() 
      {
        if(!button_value)
        {
          button_value = true
        }
      }

    function check() 
      {
        if(!button_value_2)
        {
          button_value_2 = true
        }
      }



    function drawId(markers) {
      var corners, corner, x, y, i, j;
      
      context.strokeStyle = "blue";
      context.lineWidth = 1;
      
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        x = Infinity;
        y = Infinity;
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          
          x = Math.min(x, corner.x);
          y = Math.min(y, corner.y);
        }

        context.strokeText(markers[i].id, x, y)
       
        if(button_value)
        {
          if(poses.length!=0){
            // user_Data[ip]=markers[i].id
           
            maker_id = markers[i].id.toString();
            user_Data[maker_id]=user_ip; 
            str = JSON.stringify(user_Data);
            alert(str)
            Enrollment(markers[i].id,poses[poses.length-1]) //calling enrollment function using the marker caught
            button_value = false  // button is set to false once alert window pop ups
          }
          else{
            // user_Data[ip]=markers[i].id
            Enrollment(markers[i].id,0)
            button_value = false
          }
        }

        if(button_value_2)
        {
          maker_id = markers[i].id.toString();
          if(maker_id in user_Data)
          {
            alert('Key is present')
            alert('IP of user is::' + user_Data[maker_id].toString())
            button_value_2 = false;
          }
          else
          {
            alert('Key is not present')
            button_value_2 = false;
          }
        }
        
        
      }
    }

    

// Usage

  </script>

</head>

<body style="font-family: monospace;">
  <button onclick="change()">Enroll</button>
  <button onclick="check()">Check</button>
  <center>
    <div style="margin: 10px;"><strong>-= Augmented Reality Marker Detector =-</strong></div>
    <video id="video" autoplay="true" style="display:none;"></video>
    <canvas id="canvas" style="width:640px; height:480px;"></canvas>
    <div style="margin: 15px;"><strong>Powered by <a href="http://code.google.com/p/js-aruco/">js-aruco</a></strong></div>
  </center>
  <!-- <form>
    <input id="EnrollButton" type = "button" value = "Enroll aruco tag" onclick = "change()" />
 </form> -->

</body>
  
</html>